<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QDS Battery Noise Toy</title>
<style>
  body{
    margin:0;
    background:#05060a;
    color:#e9eeff;
    font-family:system-ui,Segoe UI,Roboto,Arial;
    display:flex;
    flex-direction:column;
    min-height:100vh;
  }
  header{
    padding:10px 12px;
    background:linear-gradient(135deg,#111629,#060812);
    border-bottom:1px solid rgba(150,170,255,0.2);
  }
  h1{
    margin:0;
    font-size:16px;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  #controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    padding:8px 12px 10px;
    background:rgba(10,14,24,.9);
    border-bottom:1px solid rgba(150,170,255,0.2);
  }
  .ctrl{
    display:flex;
    flex-direction:column;
    font-size:12px;
  }
  .ctrl label{
    margin-bottom:3px;
    opacity:.85;
  }
  .ctrl input[type=range]{
    width:160px;
  }
  button{
    align-self:flex-start;
    margin-top:4px;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid rgba(150,170,255,0.35);
    background:linear-gradient(135deg,rgba(134,166,255,.18),rgba(123,255,207,.10));
    color:#e9eeff;
    font-size:12px;
    font-weight:600;
  }
  button:active{transform:translateY(1px) scale(.99);}
  #wrap{
    flex:1;
    padding:8px 6px 10px;
  }
  #canvas{
    width:100%;
    max-width:900px;
    height:360px;
    border-radius:12px;
    border:1px solid rgba(150,170,255,0.25);
    background:#050812;
    display:block;
    margin:0 auto;
  }
  #legend{
    text-align:center;
    font-size:11px;
    margin-top:4px;
    opacity:.8;
  }
</style>
</head>
<body>
<header>
  <h1>QDS Battery Noise Toy</h1>
  <div style="font-size:11px;opacity:.8;margin-top:3px;">
    Simulated battery health over cycles · compare uncorrelated vs QDS-style correlated noise
  </div>
</header>

<div id="controls">
  <div class="ctrl">
    <label for="drain">Base drain per cycle (%): <span id="drainVal">0.4</span></label>
    <input id="drain" type="range" min="0.1" max="1.0" step="0.1" value="0.4">
  </div>
  <div class="ctrl">
    <label for="noise">Noise amplitude (%): <span id="noiseVal">0.8</span></label>
    <input id="noise" type="range" min="0.1" max="2.0" step="0.1" value="0.8">
  </div>
  <div class="ctrl">
    <label for="corr">Correlation (0–0.99): <span id="corrVal">0.85</span></label>
    <input id="corr" type="range" min="0" max="0.99" step="0.01" value="0.85">
  </div>
  <div class="ctrl">
    <label for="cycles">Cycles: <span id="cyclesVal">120</span></label>
    <input id="cycles" type="range" min="40" max="300" step="10" value="120">
  </div>
  <div class="ctrl">
    <button id="runBtn">Run simulation</button>
    <button id="resetBtn" style="margin-top:4px;">Reset defaults</button>
  </div>
</div>

<div id="wrap">
  <canvas id="canvas"></canvas>
  <div id="legend">
    <span>Uncorrelated noise = thin line (more jagged)</span> ·
    <span>Correlated QDS-style noise = thick line (smoother trends, memory)</span>
  </div>
</div>

<script>
const drainEl = document.getElementById('drain');
const noiseEl = document.getElementById('noise');
const corrEl = document.getElementById('corr');
const cyclesEl = document.getElementById('cycles');
const drainVal = document.getElementById('drainVal');
const noiseVal = document.getElementById('noiseVal');
const corrVal = document.getElementById('corrVal');
const cyclesVal = document.getElementById('cyclesVal');
const runBtn = document.getElementById('runBtn');
const resetBtn = document.getElementById('resetBtn');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  const w = canvas.parentElement.clientWidth - 4;
  const h = 360;
  canvas.width = w;
  canvas.height = h;
}
addEventListener('resize', resizeCanvas);
resizeCanvas();

function updateLabels(){
  drainVal.textContent = (+drainEl.value).toFixed(1);
  noiseVal.textContent = (+noiseEl.value).toFixed(1);
  corrVal.textContent = (+corrEl.value).toFixed(2);
  cyclesVal.textContent = cyclesEl.value;
}
updateLabels();

drainEl.oninput = noiseEl.oninput = corrEl.oninput = cyclesEl.oninput = updateLabels;

function simulateBattery({drain, noiseAmp, corr, cycles}){
  // Return two arrays: uncorrelatedNoiseHealth, correlatedNoiseHealth
  let h1 = 100;
  let h2 = 100;
  let arr1 = [h1];
  let arr2 = [h2];

  let prevNoise = 0;

  for(let i=1; i<cycles; i++){
    // Uncorrelated noise: independent each step
    const n1 = (Math.random()*2-1) * noiseAmp;
    h1 = Math.max(0, Math.min(100, h1 - drain + n1));
    arr1.push(h1);

    // Correlated noise: AR(1)
    const eps = (Math.random()*2-1) * noiseAmp;
    prevNoise = corr*prevNoise + (1-corr)*eps;
    h2 = Math.max(0, Math.min(100, h2 - drain + prevNoise));
    arr2.push(h2);
  }
  return {arr1, arr2};
}

function drawSimulation(arr1, arr2){
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // background grid
  ctx.save();
  ctx.strokeStyle = 'rgba(140,160,255,0.18)';
  ctx.lineWidth = 1;
  const rows = 10;
  for(let i=0;i<=rows;i++){
    const y = (h-30)*i/rows + 10;
    ctx.beginPath();
    ctx.moveTo(40,y);
    ctx.lineTo(w-10,y);
    ctx.stroke();
  }
  ctx.restore();

  const n = arr1.length;
  const x0 = 40, x1 = w-10;
  const y0 = h-20, y1 = 10;

  function yMap(v){
    // v in [0,100]
    return y0 - (v/100)*(y0-y1);
  }
  function xMap(i){
    return x0 + (i/(n-1))*(x1-x0);
  }

  // axes
  ctx.save();
  ctx.strokeStyle = 'rgba(200,210,255,0.9)';
  ctx.lineWidth = 1.4;
  ctx.beginPath();
  ctx.moveTo(x0,y1-5);
  ctx.lineTo(x0,y0);
  ctx.lineTo(x1+5,y0);
  ctx.stroke();

  ctx.fillStyle = 'rgba(230,235,255,0.9)';
  ctx.font = '10px system-ui';
  ctx.fillText('Health (%)', 6, y1+4);
  ctx.fillText('Cycles', w/2-12, h-6);
  ctx.restore();

  // uncorrelated noise line (thin)
  ctx.save();
  ctx.strokeStyle = 'rgba(150,200,255,0.8)';
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  arr1.forEach((v,i)=>{
    const x = xMap(i);
    const y = yMap(v);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.restore();

  // correlated noise line (thicker)
  ctx.save();
  ctx.strokeStyle = 'rgba(120,255,200,0.95)';
  ctx.lineWidth = 2.0;
  ctx.beginPath();
  arr2.forEach((v,i)=>{
    const x = xMap(i);
    const y = yMap(v);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.restore();
}

function runSim(){
  const params = {
    drain: +drainEl.value,
    noiseAmp: +noiseEl.value,
    corr: +corrEl.value,
    cycles: +cyclesEl.value
  };
  const {arr1, arr2} = simulateBattery(params);
  drawSimulation(arr1, arr2);
}
runBtn.onclick = runSim;
resetBtn.onclick = () => {
  drainEl.value = 0.4;
  noiseEl.value = 0.8;
  corrEl.value = 0.85;
  cyclesEl.value = 120;
  updateLabels();
  runSim();
};

runSim();
</script>
</body>
</html>
