<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QDS • GrowthHub — Revenue Floor + Capacity Truth (v5)</title>
<style>
  :root{
    --bg:#060b14;
    --panel:#0b1220;
    --panel2:#0a111e;
    --text:#e9f1ff;
    --muted:#9fb0c9;
    --border:rgba(255,255,255,0.07);
    --shadow:0 0 0 1px rgba(255,255,255,0.06), 0 18px 40px rgba(0,0,0,0.45);

    /* Slightly more colour (tasteful) */
    --accent:#7fb3ff;
    --mint:#7fffd4;
    --teal:#4de3ff;
    --lime:#93ff8c;
    --warn:#ffd479;
    --bad:#ff7f9d;

    --radius:18px;
    --radius2:24px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 520px at 12% 0%, rgba(127,179,255,0.14), transparent 60%),
      radial-gradient(900px 620px at 90% 8%, rgba(127,255,212,0.10), transparent 60%),
      radial-gradient(700px 520px at 50% 110%, rgba(77,227,255,0.08), transparent 60%),
      linear-gradient(180deg, #050914 0%, #050913 35%, #040812 100%);
  }

  .wrap{
    max-width: 980px;
    margin: 18px auto 70px;
    padding: 0 14px;
  }

  .hero{
    padding: 18px 18px 14px;
    border-radius: var(--radius2);
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    position: relative;
    overflow:hidden;
  }
  .hero:before{
    content:"";
    position:absolute; inset:-120px -180px auto auto;
    width: 420px; height: 420px;
    background: radial-gradient(circle at 30% 30%, rgba(127,179,255,0.22), transparent 55%),
                radial-gradient(circle at 60% 60%, rgba(127,255,212,0.18), transparent 55%);
    filter: blur(2px);
    opacity:.9;
    pointer-events:none;
  }

  .titleRow{
    display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
  }
  h1{
    margin:0;
    font-size: 22px;
    line-height: 1.2;
    letter-spacing: .2px;
  }
  .sub{
    margin: 8px 0 0;
    color: var(--muted);
    line-height: 1.4;
    max-width: 740px;
  }
  .pillStack{
    display:flex; flex-wrap:wrap; gap:10px;
    margin-top: 14px;
  }
  .pill{
    border: 1px solid var(--border);
    background: rgba(10,16,28,0.55);
    border-radius: 999px;
    padding: 10px 12px;
    color: var(--muted);
    display:flex; gap:8px; align-items:center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.25);
  }
  .dot{
    width:10px; height:10px; border-radius:999px;
    background: linear-gradient(180deg, var(--accent), var(--mint));
    box-shadow: 0 0 0 3px rgba(127,179,255,0.10);
  }
  .pill strong{ color: var(--text); font-weight:700; }

  .btnRow{
    margin-top: 14px;
    display:flex; gap:10px; flex-wrap:wrap;
  }
  button{
    appearance:none;
    border: 1px solid var(--border);
    background: rgba(8,12,20,0.72);
    color: var(--text);
    padding: 10px 12px;
    border-radius: 14px;
    box-shadow: 0 10px 22px rgba(0,0,0,0.28);
    cursor:pointer;
    font-weight: 650;
    letter-spacing:.1px;
  }
  button:hover{ border-color: rgba(127,179,255,0.35); }
  button:active{ transform: translateY(1px); }

  .grid{
    margin-top: 16px;
    display:grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }

  @media (min-width: 880px){
    .grid{ grid-template-columns: 1.08fr 0.92fr; }
  }

  .card{
    border: 1px solid var(--border);
    background: rgba(9,14,24,0.70);
    border-radius: var(--radius2);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding: 14px 16px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    display:flex; justify-content:space-between; gap:10px; align-items:baseline; flex-wrap:wrap;
  }
  .cardHead h2{
    margin:0;
    font-size: 16px;
    letter-spacing:.2px;
  }
  .hint{
    color: var(--muted);
    font-size: 12.5px;
  }
  .cardBody{
    padding: 12px 16px 14px;
  }

  .field{
    margin: 10px 0;
    display:grid;
    grid-template-columns: 1fr;
    gap: 6px;
  }
  .field .labRow{
    display:flex; justify-content:space-between; gap:10px; align-items:baseline;
    color: var(--muted);
    font-size: 12.5px;
  }
  .field .labRow b{
    color: var(--text);
    font-weight: 650;
  }
  input, select, textarea{
    width:100%;
    background: rgba(6,10,18,0.75);
    border: 1px solid rgba(255,255,255,0.10);
    color: var(--text);
    border-radius: 14px;
    padding: 12px 12px;
    font-size: 15px;
    outline:none;
  }
  textarea{ min-height: 72px; resize: vertical; }
  input:focus, select:focus, textarea:focus{
    border-color: rgba(127,179,255,0.45);
    box-shadow: 0 0 0 3px rgba(127,179,255,0.12);
  }

  .outputs{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 520px){
    .outputs{ grid-template-columns: 1fr 1fr; }
  }

  .metric{
    border: 1px solid rgba(255,255,255,0.07);
    background: rgba(6,10,18,0.65);
    border-radius: var(--radius);
    padding: 14px 14px 12px;
    position:relative;
    overflow:hidden;
  }
  .metric:before{
    content:"";
    position:absolute; inset:-1px auto auto -1px;
    width: 140px; height: 140px;
    background: radial-gradient(circle at 20% 20%, rgba(77,227,255,0.16), transparent 62%);
    pointer-events:none;
  }
  .metric .k{ color: var(--muted); font-size: 12.5px; }
  .metric .v{
    margin-top: 6px;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: .3px;
  }
  .metric .s{ margin-top: 2px; color: var(--muted); font-size: 12.5px; }

  .rowLine{
    margin-top: 10px;
    color: var(--muted);
    font-size: 13px;
    line-height: 1.45;
  }
  .rowLine b{ color: var(--text); }
  .divider{ height:1px; background: rgba(255,255,255,0.06); margin: 12px 0; }

  table{
    width:100%;
    border-collapse: collapse;
  }
  th, td{
    text-align:left;
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    vertical-align: top;
  }
  th{
    color: var(--muted);
    font-size: 12px;
    letter-spacing: .3px;
    text-transform: uppercase;
  }
  td{
    font-size: 13.5px;
    color: var(--text);
  }

  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding: 5px 9px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(6,10,18,0.65);
    color: var(--muted);
    font-size: 12.5px;
    white-space: nowrap;
  }
  .chip .cDot{ width:9px; height:9px; border-radius:999px; }
  .cLow{ background: rgba(255,212,121,0.15); color: #ffe6b1; border-color: rgba(255,212,121,0.22); }
  .cMed{ background: rgba(77,227,255,0.12); color: #c7f7ff; border-color: rgba(77,227,255,0.22); }
  .cHigh{ background: rgba(147,255,140,0.12); color: #d9ffd6; border-color: rgba(147,255,140,0.22); }

  .good{ color: #bfffd0; font-weight: 800; }
  .neutral{ color: var(--muted); font-weight: 800; }
  .bad{ color: #ffd0dc; font-weight: 800; }

  .boardBox{
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(6,10,18,0.65);
    border-radius: var(--radius);
    padding: 12px 12px;
    color: var(--muted);
    line-height: 1.45;
  }
  .boardBox b{ color: var(--text); }

  .miniBtnRow{
    display:flex; flex-wrap:wrap; gap:10px;
    margin-top: 10px;
  }
  .miniBtnRow button{
    padding: 10px 12px;
    border-radius: 14px;
  }

  /* One-pager mode */
  body.onepager .inputsCard,
  body.onepager .persistCard{ display:none; }
  body.onepager .grid{ grid-template-columns: 1fr; }

  @media print{
    body{ background: #fff; color:#000; }
    .hero, .card, .metric, .boardBox{ box-shadow:none !important; }
    .hero, .card{ background:#fff !important; border-color:#ddd !important; }
    .pill, button{ display:none !important; }
    .wrap{ margin:0; padding:0; max-width: 100%; }
    .metric{ border-color:#ddd !important; }
    .cardHead{ border-color:#ddd !important; }
    th,td{ border-color:#ddd !important; }
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="hero">
    <div class="titleRow">
      <div>
        <h1>QDS • GrowthHub — Revenue Floor + Capacity Truth <span style="opacity:.75">(v5)</span></h1>
        <p class="sub">
          Single-file business system: demand → conversion → capacity caps → MRR accumulation → assumption audit.
          Built for honest planning, not hype.
        </p>
      </div>
    </div>

    <div class="btnRow">
      <button id="btnToggleOnePager">Toggle One-Pager View</button>
      <button id="btnPrint">Print One-Pager</button>
      <button id="btnCopyBoard">Copy Board Summary</button>
      <button id="btnReset">Reset to Base</button>
    </div>

    <div class="pillStack">
      <div class="pill"><span class="dot"></span><span><strong>Purpose:</strong> show revenue floor under realistic conversion + capacity</span></div>
      <div class="pill"><span class="dot"></span><span><strong>Output:</strong> monthly rev, yearly run-rate, MRR @ horizon</span></div>
      <div class="pill"><span class="dot"></span><span><strong>Truth:</strong> caps stop “infinite sprints” fantasy</span></div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT: Inputs -->
    <div class="card inputsCard">
      <div class="cardHead">
        <h2>Inputs</h2>
        <div class="hint">Preset → sane defaults. Rates in 0–1.</div>
      </div>
      <div class="cardBody">

        <div class="field">
          <div class="labRow"><span><b>Preset</b></span><span class="hint">Mode</span></div>
          <select id="mode">
            <option value="conservative">Conservative</option>
            <option value="base" selected>Base</option>
            <option value="optimistic">Optimistic (still sane)</option>
          </select>
        </div>

        <div class="field">
          <div class="labRow"><span><b>Currency label (display)</b></span><span class="hint">Symbol only</span></div>
          <input id="sym" type="text" value="£" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Months to project</b></span><span class="hint">MRR horizon</span></div>
          <input id="months" type="number" min="1" step="1" value="12" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Starting MRR</b></span><span class="hint">M0</span></div>
          <input id="m0" type="number" min="0" step="1" value="0" />
        </div>

        <div class="divider"></div>

        <div style="color:var(--muted); font-weight:750; letter-spacing:.2px;">Demand</div>

        <div class="field">
          <div class="labRow"><span><b>Leads / month</b></span><span class="hint">L</span></div>
          <input id="L" type="number" min="0" step="1" value="6" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Qualified rate (0–1)</b></span><span class="hint">q</span></div>
          <input id="q" type="number" min="0" max="1" step="0.01" value="0.40" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Sprint close of qualified (0–1)</b></span><span class="hint">s</span></div>
          <input id="s" type="number" min="0" max="1" step="0.01" value="0.25" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Pilot-from-sprint (0–1)</b></span><span class="hint">p</span></div>
          <input id="p" type="number" min="0" max="1" step="0.01" value="0.30" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Retainer-from-pilot (0–1)</b></span><span class="hint">r</span></div>
          <input id="r" type="number" min="0" max="1" step="0.01" value="0.20" />
        </div>

        <div class="rowLine">
          Tip: keep rates in <b>0–1</b> format. This model auto-caps sprints/pilots using your capacity values.
        </div>

        <div class="divider"></div>

        <div style="color:var(--muted); font-weight:750; letter-spacing:.2px;">Pricing + Capacity</div>

        <div class="field">
          <div class="labRow"><span><b>Sprint price</b></span><span class="hint" id="labSprint">£ / sprint</span></div>
          <input id="sprintPrice" type="number" min="0" step="50" value="2500" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Pilot price</b></span><span class="hint" id="labPilot">£ / pilot</span></div>
          <input id="pilotPrice" type="number" min="0" step="50" value="3500" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Retainer / month</b></span><span class="hint" id="labRet">£ / mo</span></div>
          <input id="retainerMonth" type="number" min="0" step="10" value="800" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Max sprints / month</b></span><span class="hint">Smax</span></div>
          <input id="Smax" type="number" min="0" step="1" value="2" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Max pilots / month</b></span><span class="hint">Pmax</span></div>
          <input id="Pmax" type="number" min="0" step="1" value="1" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Monthly churn %</b></span><span class="hint">c</span></div>
          <input id="c" type="number" min="0" step="0.1" value="3.0" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Cost base / month (optional)</b></span><span class="hint">£</span></div>
          <input id="cost" type="number" min="0" step="10" value="0" />
        </div>

        <div class="field">
          <div class="labRow"><span><b>Notes (optional)</b></span><span class="hint">assumption context</span></div>
          <textarea id="notes" placeholder="e.g., 2 days/week available; partner work pending; outbound leads from X; etc."></textarea>
        </div>

      </div>
    </div>

    <!-- RIGHT: Outputs + Audit + Sensitivity -->
    <div class="card">
      <div class="cardHead">
        <h2>Live Outputs</h2>
        <div class="hint">Honest caps + churned MRR</div>
      </div>

      <div class="cardBody">
        <div class="outputs">
          <div class="metric">
            <div class="k">Revenue / Month</div>
            <div class="v" id="revMonthOut">—</div>
            <div class="s">Sprints + Pilots + New MRR</div>
          </div>

          <div class="metric">
            <div class="k">Revenue / Year (Run-Rate)</div>
            <div class="v" id="runRateOut">—</div>
            <div class="s">Conservative if capacity-capped</div>
          </div>

          <div class="metric">
            <div class="k">New MRR / Month</div>
            <div class="v" id="newMRROut">—</div>
            <div class="s">Based on new retainers</div>
          </div>

          <div class="metric">
            <div class="k">Projected MRR @ Horizon</div>
            <div class="v" id="mrrHOut">—</div>
            <div class="s" id="mrrHSub">MRR after churn</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="rowLine" id="volLine">—</div>
        <div class="rowLine" id="mrrLine">—</div>

        <div class="divider"></div>

        <div class="boardBox" id="boardSummaryBox">
          <b>Board summary (auto)</b><br/>
          <span id="boardSummaryText">—</span><br/><br/>
          <span style="opacity:.9">This line is designed to be copy-safe for meetings.</span>
        </div>

        <div class="divider"></div>

        <div class="cardHead" style="padding:0 0 10px;border:0">
          <h2 style="margin:0;font-size:15px;">Assumption Audit</h2>
          <div class="hint">Confidence turns a calculator into a calibrated system.</div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:34%">Assumption</th>
              <th style="width:18%">Value</th>
              <th style="width:18%">Confidence</th>
              <th>Evidence note</th>
            </tr>
          </thead>
          <tbody id="auditBody">
            <!-- filled by JS -->
          </tbody>
        </table>

        <div class="divider"></div>

        <div class="cardHead" style="padding:0 0 10px;border:0">
          <h2 style="margin:0;font-size:15px;">What Moves the Needle (Sensitivity)</h2>
          <div class="hint">Local deltas; decision-chat friendly.</div>
        </div>

        <table id="sensTable">
          <thead>
            <tr>
              <th style="width:48%">Change</th>
              <th style="width:26%">Δ yearly run-rate</th>
              <th>≈ Δ per month</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>+1 lead / month</td><td id="s_y1">—</td><td id="s_m1">—</td></tr>
            <tr><td>+0.10 sprint close rate</td><td id="s_y2">—</td><td id="s_m2">—</td></tr>
            <tr><td>+1 sprint capacity</td><td id="s_y3">—</td><td id="s_m3">—</td></tr>
            <tr><td>+0.05 pilot-from-sprint</td><td id="s_y4">—</td><td id="s_m4">—</td></tr>
            <tr><td>+0.05 retainer-from-pilot</td><td id="s_y5">—</td><td id="s_m5">—</td></tr>
          </tbody>
        </table>

        <div class="rowLine" style="margin-top:10px;">
          Simple local deltas. Good enough for decision chat; not pretending to be a full Monte Carlo.
        </div>

      </div>
    </div>

  </div>

  <div class="card persistCard" style="margin-top:14px;">
    <div class="cardHead">
      <h2>Persistence</h2>
      <div class="hint">Save your assumptions between sessions</div>
    </div>
    <div class="cardBody">
      <div class="miniBtnRow">
        <button id="btnSaveLS">Save to localStorage</button>
        <button id="btnLoadLS">Load from localStorage</button>
        <button id="btnDefaults">Load defaults</button>
      </div>
      <div class="rowLine" style="margin-top:10px;">
        Stored key: <span style="color:var(--mint);font-weight:750;">QDS_GrowthHub_RevenueFloor_v5</span>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const KEY = "QDS_GrowthHub_RevenueFloor_v5";

  const presets = {
    conservative: {
      L:4, q:0.35, s:0.20, p:0.25, r:0.15,
      sprintPrice:2200, pilotPrice:3200, retainerMonth:650,
      Smax:1, Pmax:1, months:12, m0:0, c:3.5, cost:0
    },
    base: {
      /* Lower, more realistic starting point (no “£15k/mo out the gate”) */
      L:6, q:0.40, s:0.25, p:0.30, r:0.20,
      sprintPrice:2500, pilotPrice:3500, retainerMonth:800,
      Smax:2, Pmax:1, months:12, m0:0, c:3.0, cost:0
    },
    optimistic: {
      L:10, q:0.50, s:0.30, p:0.35, r:0.25,
      sprintPrice:3000, pilotPrice:4200, retainerMonth:1000,
      Smax:3, Pmax:2, months:12, m0:0, c:2.5, cost:0
    }
  };

  function clamp01(x){ x = Number(x); if(!isFinite(x)) return 0; return Math.max(0, Math.min(1, x)); }
  function num(x, def=0){ x = Number(x); return isFinite(x) ? x : def; }

  function sym(){
    const s = String($("sym").value || "£").trim();
    return s.length ? s : "£";
  }

  function fmtMoney(x){
    const s = sym();
    if(!isFinite(x)) return "—";
    const v = Math.round(x);
    return s + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }

  function fmtMoneySigned(x){
    const s = sym();
    if(!isFinite(x)) return "—";
    const sign = x > 0 ? "+" : (x < 0 ? "−" : "±");
    const v = Math.round(Math.abs(x));
    return sign + s + v.toLocaleString(undefined,{maximumFractionDigits:0});
  }

  function readInputs(){
    return {
      L: num($("L").value),
      q: clamp01($("q").value),
      s: clamp01($("s").value),
      p: clamp01($("p").value),
      r: clamp01($("r").value),
      sprintPrice: num($("sprintPrice").value),
      pilotPrice: num($("pilotPrice").value),
      retainerMonth: num($("retainerMonth").value),
      Smax: num($("Smax").value),
      Pmax: num($("Pmax").value),
      months: Math.max(1, Math.floor(num($("months").value, 12))),
      m0: Math.max(0, num($("m0").value)),
      c: Math.max(0, num($("c").value)) / 100.0,
      cost: Math.max(0, num($("cost").value)),
      notes: String($("notes").value||"")
    };
  }

  // Core model (math kept clean and consistent)
  function model(inp){
    const qualified = inp.L * inp.q;

    const sprintsRaw = qualified * inp.s;
    const sprints = (isFinite(inp.Smax) && inp.Smax >= 0) ? Math.min(sprintsRaw, inp.Smax) : sprintsRaw;

    const pilotsRaw = sprints * inp.p;
    const pilots = (isFinite(inp.Pmax) && inp.Pmax >= 0) ? Math.min(pilotsRaw, inp.Pmax) : pilotsRaw;

    const newRetainers = pilots * inp.r;

    const revMonth =
      sprints * inp.sprintPrice +
      pilots  * inp.pilotPrice +
      newRetainers * inp.retainerMonth;

    const runRateYear = revMonth * 12;

    // MRR accumulation with churn
    const mrrTrack = [];
    let mrr = inp.m0;
    for(let t=1; t<=inp.months; t++){
      mrr = mrr * (1 - inp.c) + newRetainers * inp.retainerMonth;
      mrrTrack.push(mrr);
    }

    function mAt(month){
      if(month <= 0) return inp.m0;
      if(month > mrrTrack.length) return mrrTrack[mrrTrack.length-1] ?? inp.m0;
      return mrrTrack[month-1];
    }

    return {
      qualified,
      sprintsRaw, sprints,
      pilotsRaw, pilots,
      newRetainers,
      revMonth, runRateYear,
      mrrTrack,
      mrr3: mAt(3),
      mrr6: mAt(6),
      mrr12: mAt(12),
      mrrH: mAt(inp.months),
    };
  }

  function setAudit(inp){
    const tbody = $("auditBody");
    tbody.innerHTML = "";

    const rows = [
      {k:"Qualified rate (q)", v: inp.q.toFixed(2), conf:"Med", note:"How many leads are actually in-scope."},
      {k:"Sprint close (s)", v: inp.s.toFixed(2), conf:"Med", note:"Conversion from qualified to paid sprint."},
      {k:"Pilot-from-sprint (p)", v: inp.p.toFixed(2), conf:"Med", note:"Who extends from sprint into pilot."},
      {k:"Retainer-from-pilot (r)", v: inp.r.toFixed(2), conf:"Med", note:"Pilot → ongoing retainer conversion."},
      {k:"Churn (c)", v: (inp.c*100).toFixed(1) + "%", conf:"Low", note:"Until you have 6–12 months data."},
      {k:"Capacity caps", v: `Smax=${inp.Smax}, Pmax=${inp.Pmax}`, conf:"High", note:"Your time/ops reality (non-negotiable)."},
    ];

    function confChip(level){
      let cls="chip cMed", dot="var(--teal)";
      if(level==="Low"){ cls="chip cLow"; dot="var(--warn)"; }
      if(level==="High"){ cls="chip cHigh"; dot="var(--lime)"; }
      return `<span class="${cls}"><span class="cDot" style="background:${dot}"></span>${level}</span>`;
    }

    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.k}</td>
        <td>${r.v}</td>
        <td>${confChip(r.conf)}</td>
        <td style="color:var(--muted)">${r.note}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function setSensitivity(inp, base){
    const scenarios = [
      { idy:"s_y1", idm:"s_m1", mod: x => ({...x, L: x.L + 1}) },
      { idy:"s_y2", idm:"s_m2", mod: x => ({...x, s: clamp01(x.s + 0.10)}) },
      { idy:"s_y3", idm:"s_m3", mod: x => ({...x, Smax: (isFinite(x.Smax) ? x.Smax + 1 : x.Smax)}) },
      { idy:"s_y4", idm:"s_m4", mod: x => ({...x, p: clamp01(x.p + 0.05)}) },
      { idy:"s_y5", idm:"s_m5", mod: x => ({...x, r: clamp01(x.r + 0.05)}) },
    ];

    for(const sc of scenarios){
      const m = model(sc.mod(inp));
      const dy = m.runRateYear - base.runRateYear;
      const dm = m.revMonth - base.revMonth;

      const yEl = $(sc.idy);
      const mEl = $(sc.idm);

      yEl.textContent = fmtMoneySigned(dy);
      mEl.textContent = fmtMoneySigned(dm);

      // colour by sign
      const cls = (dy > 1e-9) ? "good" : (dy < -1e-9) ? "bad" : "neutral";
      yEl.className = cls;
      mEl.className = cls;
    }
  }

  function render(){
    const inp = readInputs();

    // keep currency hints synced
    const s = sym();
    $("labSprint").textContent = `${s} / sprint`;
    $("labPilot").textContent  = `${s} / pilot`;
    $("labRet").textContent    = `${s} / mo`;

    const m = model(inp);

    $("revMonthOut").textContent = fmtMoney(m.revMonth);
    $("runRateOut").textContent  = fmtMoney(m.runRateYear);
    $("newMRROut").textContent   = fmtMoney(m.newRetainers * inp.retainerMonth);
    $("mrrHOut").textContent     = fmtMoney(m.mrrH);
    $("mrrHSub").textContent     = `MRR after churn @ ${inp.months} month${inp.months===1?"":"s"}`;

    $("volLine").innerHTML =
      `<b>Expected volumes / month</b><br/>
      Qualified: <b>${m.qualified.toFixed(2)}</b> •
      Sprints: <b>${m.sprints.toFixed(2)}</b> <span style="opacity:.8">(raw ${m.sprintsRaw.toFixed(2)})</span> •
      Pilots: <b>${m.pilots.toFixed(2)}</b> <span style="opacity:.8">(raw ${m.pilotsRaw.toFixed(2)})</span> •
      New retainers: <b>${m.newRetainers.toFixed(2)}</b>`;

    // MRR keypoints
    const m3 = (inp.months >= 3) ? fmtMoney(m.mrr3) : "—";
    const m6 = (inp.months >= 6) ? fmtMoney(m.mrr6) : "—";
    const m12= (inp.months >= 12)? fmtMoney(m.mrr12): "—";

    $("mrrLine").innerHTML =
      `<b>MRR accumulation</b><br/>
      Starting: <b>${fmtMoney(inp.m0)}</b> •
      MRR @ 3 mo: <b>${m3}</b> •
      MRR @ 6 mo: <b>${m6}</b> •
      MRR @ 12 mo: <b>${m12}</b> •
      MRR @ horizon: <b>${fmtMoney(m.mrrH)}</b>`;

    const board = `Base plan: ${fmtMoney(m.revMonth)}/mo revenue → ${fmtMoney(m.runRateYear)}/yr run-rate. Adds ${fmtMoney(m.newRetainers * inp.retainerMonth)}/mo new MRR; projected MRR @ ${inp.months} months: ${fmtMoney(m.mrrH)}.`;
    $("boardSummaryText").textContent = board;

    setAudit(inp);
    setSensitivity(inp, m);
  }

  function applyPreset(name){
    const p = presets[name] || presets.base;
    $("L").value = p.L;
    $("q").value = p.q;
    $("s").value = p.s;
    $("p").value = p.p;
    $("r").value = p.r;
    $("sprintPrice").value = p.sprintPrice;
    $("pilotPrice").value = p.pilotPrice;
    $("retainerMonth").value = p.retainerMonth;
    $("Smax").value = p.Smax;
    $("Pmax").value = p.Pmax;
    $("months").value = p.months;
    $("m0").value = p.m0;
    $("c").value = (p.c*100).toFixed(1);
    $("cost").value = p.cost;
    render();
  }

  function saveLS(){
    const inp = readInputs();
    localStorage.setItem(KEY, JSON.stringify(inp));
  }

  function loadLS(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const x = JSON.parse(raw);
      for(const k of ["sym","months","m0","L","q","s","p","r","sprintPrice","pilotPrice","retainerMonth","Smax","Pmax","c","cost","notes"]){
        if($(k) && x[k] !== undefined) $(k).value = x[k];
      }
      render();
    }catch(e){}
  }

  // Wire events
  document.addEventListener("input", (e)=>{ if(e.target && (e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.tagName==="TEXTAREA")) render(); }, true);
  document.addEventListener("change", (e)=>{ if(e.target && (e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.tagName==="TEXTAREA")) render(); }, true);

  $("mode").addEventListener("change", ()=>applyPreset($("mode").value));

  $("btnToggleOnePager").addEventListener("click", ()=>{
    document.body.classList.toggle("onepager");
  });

  $("btnPrint").addEventListener("click", ()=>window.print());

  $("btnCopyBoard").addEventListener("click", async ()=>{
    const text = $("boardSummaryText").textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      $("btnCopyBoard").textContent = "Copied ✓";
      setTimeout(()=> $("btnCopyBoard").textContent="Copy Board Summary", 900);
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove();
    }
  });

  $("btnReset").addEventListener("click", ()=>{
    $("mode").value = "base";
    $("sym").value = "£";
    $("notes").value = "";
    applyPreset("base");
  });

  $("btnSaveLS").addEventListener("click", ()=>{ saveLS(); });
  $("btnLoadLS").addEventListener("click", ()=>{ loadLS(); });
  $("btnDefaults").addEventListener("click", ()=>{ $("mode").value="base"; $("sym").value="£"; $("notes").value=""; applyPreset("base"); });

  // First paint
  applyPreset("base");
})();
</script>
</body>
</html>
